+++
title = "单元测试之一：初识单元测试"
date = "2021-09-03T22:40:15+08:00"
tags = ["单元测试"]
slug = "/unitTest1"
draft = false
categories = ["技术"]
+++

# 单元测试之初识单元测试

单元测试是编写测试代码，用来检测特定的、明确的、细颗粒的功能。单元测试并不一定保证程序功能是正确的，更不保证整体业务是准备的。单元测试不仅仅用来保证当前代码的正确性，更重要的是用来保证代码**修复**、**改进**或**重构**之后的正确性。



与之相应的，有集成测试（ Integration Testing）——集成测试是在单元测试的基础上，将所有模块按照概要设计要求组装成为子系统或系统，验证组装后功能以及模块间接口是否正确的测试工作。集成测试也叫组装测试、联合测试、子系统测试或部件测试。最简单的集成测试的例子：

```java
@RunWith(SpringRunner.class)
@SpringBootTest(
  SpringBootTest.WebEnvironment.MOCK,
  classes = Application.class)
@AutoConfigureMockMvc
@TestPropertySource(
  locations = "classpath:application-integrationtest.properties")
public class EmployeeRestControllerIntegrationTest {

    @Autowired
    private MockMvc mvc;

    @Autowired
    private EmployeeRepository repository;

    // write test cases here
}

```

需要注意的是，整个容器加载完成后才会执行集成测试。而在实际开发过程中，我们往往只需要验证自己所负责的功能模块，也就是需要快速的启动和验证，所以只需要注入相关依赖并执行即可。

## 一、单元测试的基本方法

1. 接口功能测试：用来保证接口功能的正确性。

2. 数据结构测试：用来保证接口中的数据结构是正确的，比如变量有无初始值、变量是否溢出等

3. 边界条件测试
   1. **变量没有赋值**（即为NULL）
   2. 变量是数值（或字符)
      1. **主要边界**：最小值，最大值，无穷大（对于DOUBLE等）
      2. **溢出边界**（期望异常或拒绝服务）：最小值-1，最大值+1
      3. **临近边界**：最小值+1，最大值-1
   3. 变量是字符串：空字符串、可能引发异常的字符串
   4. 变量是集合：空集合、集合的边界

4. 所有独立执行通路测试：**代码覆盖率**
   1. 语句覆盖：保证每一个语句都执行到了
   2. 判定覆盖（分支覆盖）：保证每一个分支都执行到
   3. 条件覆盖：保证每一个条件都覆盖到true和false（即if、while中的条件语句）
   4. 路径覆盖：保证每一个路径都覆盖到

5. 错误处理通路测试：保证每一个异常都经过测试

6. 关于mock

   （1）Mock可以用来解除测试对象对外部服务的依赖（比如数据库，第三方接口等），使得测试用例可以独立运行。不管是传统的单体应用，还是现在流行的微服务，这点都特别重要，因为任何外部依赖的存在都会极大的限制测试用例的可迁移性和稳定性。

   （2）Mock的第二个好处是替换外部服务调用，提升测试用例的运行速度。任何外部服务调用至少是跨进程级别的消耗，甚至是跨系统、跨网络的消耗，而Mock可以把消耗降低到进程内。比如原来一次秒级的网络请求，通过Mock可以降至毫秒级，整整3个数量级的差别。

   （3）Mock的第三个好处是提升测试效率。这里说的测试效率有两层含义。第一层含义是单位时间运行的测试用例数，这是运行速度提升带来的直接好处。而第二层含义是一个测试人员单位时间创建的测试用例数。

## 二、原则（摘自阿里巴巴开发规范，可参考）

1. 【强制】好的单元测试必须遵守 AIR 原则。 说明：单元测试在线上运行时，感觉像空气（AIR）一样并不存在，但在测试质量的保障上，却是非常关键的。好的单元测试宏观上来说，具有自动化、独立性、可重复执行的特点。
   - A：Automatic（自动化）
   - I：Independent（独立性）
   - R：Repeatable（可重复）
2. 【强制】单元测试应该是全自动执行的，并且非交互式的。测试用例通常是被定期执行的， 执行过程必须完全自动化才有意义。输出结果需要人工检查的测试不是一个好的单元测试。 **单元测试中不准使用 System.out 来进行人肉验证，必须使用 assert 来验证。**
3. 【强制】保持单元测试的独立性。为了保证单元测试稳定可靠且便于维护，单元测试用例之 间决不能互相调用，也不能依赖执行的先后次序。 反例：method2 需要依赖 method1 的执行，将执行结果作为 method2 的输入。
4. 【强制】单元测试是可以重复执行的，不能受到外界环境的影响。 说明：单元测试通常会被放到持续集成中，每次有代码 check in 时单元测试都会被执行。如果单测对外部 环境（网络、服务、中间件等）有依赖，容易导致持续集成机制的不可用。 正例：为了不受外界环境影响，要求设计代码时就把 SUT 的依赖改成注入，在测试时用 spring 这样的 DI 框架注入一个本地（内存）实现或者 Mock 实现。
5. 【强制】对于单元测试，要保证测试粒度足够小，有助于精确定位问题。单测粒度至多是类 级别，一般是方法级别。 说明：只有测试粒度小才能在出错时尽快定位到出错位置。单测不负责检查跨类或者跨系统的交互逻辑， 那是集成测试的领域。
6. 【强制】核心业务、核心应用、核心模块的增量代码确保单元测试通过。 说明：新增代码及时补充单元测试，如果新增代码影响了原有单元测试，请及时修正。
7. 【强制】**单元测试代码必须写在如下工程目录：src/test/java，不允许写在业务代码目录下。** 说明：源码编译时会跳过此目录，而单元测试框架默认是扫描此目录。
8. 【推荐】单元测试的基本目标：语句覆盖率达到 70%；核心模块的语句覆盖率和分支覆盖率 都要达到 100% 说明：在工程规约的应用分层中提到的 DAO 层，Manager 层，可重用度高的 Service，都应该进行单元 测试。
9. 【推荐】编写单元测试代码遵守 BCDE 原则，以保证被测试模块的交付质量。
   - B：Border，边界值测试，包括循环边界、特殊取值、特殊时间点、数据顺序等。
   - C：Correct，正确的输入，并得到预期的结果。
   - D：Design，与设计文档相结合，来编写单元测试。
   - E：Error，强制错误信息输入（如：非法数据、异常流程、业务允许外等），并得到预期的结果。
10. 【推荐】对于数据库相关的查询，更新，删除等操作，不能假设数据库里的数据是存在的， 或者直接操作数据库把数据插入进去，请使用程序插入或者导入数据的方式来准备数据。 反例：删除某一行数据的单元测试，在数据库中，先直接手动增加一行作为删除目标，但是这一行新增数 据并不符合业务插入规则，导致测试结果异常。
11. 【推荐】和数据库相关的单元测试，可以设定自动回滚机制，不给数据库造成脏数据。或者 对单元测试产生的数据有明确的前后缀标识。 正例：在企业智能事业部的内部单元测试中，使用 ENTERPRISE_INTELLIGENCE _UNIT_TEST_的前缀来 标识单元测试相关代码。
12. 【推荐】对于不可测的代码在适当的时机做必要的重构，使代码变得可测，避免为了达到测 试要求而书写不规范测试代码。
13. 【推荐】在设计评审阶段，开发人员需要和测试人员一起确定单元测试范围，单元测试最好 覆盖所有测试用例。
14. 【推荐】单元测试作为一种质量保障手段，在项目提测前完成单元测试，不建议项目发布后 补充单元测试用例。
15. 【参考】为了更方便地进行单元测试，业务代码应避免以下情况： 构造方法中做的事情过多。
    - 存在过多的全局变量和静态方法。
    - 存在过多的外部依赖。
    - 存在过多的条件语句。 说明：多层条件语句建议使用卫语句、策略模式、状态模式等方式重构。
16. 【参考】不要对单元测试存在如下误解：
    - 那是测试同学干的事情。本文是开发手册，凡是本文内容都是与开发同学强相关的。
    - 单元测试代码是多余的。系统的整体功能与各单元部件的测试正常与否是强相关的。
    - 单元测试代码不需要维护。一年半载后，那么单元测试几乎处于废弃状态。
    - 单元测试与线上故障没有辩证关系。好的单元测试能够最大限度地规避线上故障。

## 三、规范

#### 1. 单元测试代码的位置

单元测试的代码统一放在**`ers-web/src/test`**目录下，并且目录结构与要测试的测试类保持一致。例如对`com.kedacom.ers.police.alarm.controller.AlarmInfoController`进行单元测试时，相应的单元测试类也应该放在test下相应的位置。

#### 2. 单元测试类的命名规范

**被测试的类名+方法名（业务名）+ Test**，例如`AlarmInfoControllerJqxxTest`表示这是对`AlarmInfoController`这个类中关于警情信息相关业务的测试用例。

#### 3. 测试用例的命名定义规范

**方法名\_输入_期望的输出**

比如：dataList_nullParams_ExceptionThrown

[7 Popular Unit Test Naming Conventions - DZone Agile](https://dzone.com/articles/7-popular-unit-test-naming)

#### 4.变量的命名规范

 保持跟开发规范一致

#### 5.常量的命名规范

 保持跟开发规范一致

#### 6. 单元测试的组成

1. **准备(Arrange)**队形，创建对象，打桩（mock），进行必要的设置；
2. **操作(Act)**对象；
3. **断言(Assert)**某件事情是预期的。